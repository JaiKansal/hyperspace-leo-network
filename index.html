<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>HyperSpace - Educational Mode</title>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.104/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #000;
            font-family: 'Segoe UI', sans-serif;
            color: #fff;
        }

        #cesiumContainer {
            width: 100%;
            height: 100vh;
            transition: filter 0.5s;
        }

        /* HAZARD OVERLAYS (The Visual Feedback) */
        .solar-alert {
            animation: solarPulse 2s infinite;
        }

        @keyframes solarPulse {
            0% {
                box-shadow: inset 0 0 0 rgba(255, 50, 0, 0);
            }

            50% {
                box-shadow: inset 0 0 100px rgba(255, 50, 0, 0.5);
            }

            100% {
                box-shadow: inset 0 0 0 rgba(255, 50, 0, 0);
            }
        }

        /* PANELS */
        .panel {
            position: absolute;
            background: rgba(0, 10, 20, 0.95);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 8px;
            padding: 15px;
            backdrop-filter: blur(12px);
        }

        .top-left {
            top: 20px;
            left: 20px;
            width: 260px;
        }

        .top-right {
            top: 20px;
            right: 20px;
            width: 360px;
        }

        h3 {
            color: #00d4ff;
            margin: 0 0 15px 0;
            font-size: 1.1em;
            border-bottom: 1px solid #333;
            padding-bottom: 8px;
            text-transform: uppercase;
        }

        /* EXPLANATION BOX (New Feature) */
        #storyBox {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 600px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #fff;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            display: none;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
        }

        #storyTitle {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        #storyText {
            font-size: 1.1em;
            color: #ddd;
            line-height: 1.5;
        }

        /* CONTROLS */
        .search-box {
            position: relative;
            margin-bottom: 15px;
        }

        .text-input {
            width: 100%;
            background: #111;
            border: 1px solid #444;
            color: #fff;
            padding: 10px;
            border-radius: 4px;
        }

        .suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #111;
            border: 1px solid #333;
            z-index: 1000;
            display: none;
        }

        .suggestion-item {
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid #222;
        }

        .suggestion-item:hover {
            background: #00d4ff;
            color: #000;
        }

        .btn {
            display: block;
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid #00d4ff;
            color: #00d4ff;
            cursor: pointer;
            font-weight: bold;
        }

        .btn:hover {
            background: rgba(0, 212, 255, 0.4);
        }

        .btn-hazard {
            border-color: #ff3333;
            color: #ff3333;
        }

        .btn-hazard:hover {
            background: rgba(255, 50, 50, 0.2);
        }

        .metric {
            display: flex;
            justify-content: space-between;
            margin: 6px 0;
            font-size: 0.9em;
            color: #aaa;
        }

        .val {
            color: #fff;
            font-weight: bold;
        }

        .val.ok {
            color: #00ff88;
        }

        .val.err {
            color: #ff3333;
        }
    </style>
</head>

<body>
    <div id="cesiumContainer"></div>

    <div id="storyBox">
        <div id="storyTitle">‚ö†Ô∏è ALERT</div>
        <div id="storyText">Details...</div>
    </div>

    <div class="panel top-left">
        <h3>üõ∞Ô∏è System Status</h3>
        <div class="metric"><span>Satellites</span><span class="val ok" id="satCount">0</span></div>
        <div class="metric"><span>Environment</span><span class="val" id="envState">NORMAL</span></div>
    </div>

    <div class="panel top-right">
        <h3>‚ö° Mission Control</h3>
        <div class="search-box"><input id="srcInput" class="text-input" type="text" placeholder="Source (e.g. Hapur)">
            <div id="srcList" class="suggestions"></div>
        </div>
        <div class="search-box"><input id="dstInput" class="text-input" type="text"
                placeholder="Destination (e.g. London)">
            <div id="dstList" class="suggestions"></div>
        </div>

        <button class="btn" onclick="calcRoute()">üì° Calculate Route</button>
        <button class="btn" onclick="startFlightSim()">‚úàÔ∏è Sim: Tokyo ‚Üí Sydney</button>

        <div style="display: flex; gap: 5px; margin-top: 15px;">
            <button class="btn btn-hazard" onclick="toggleRain()">üåßÔ∏è Rain Event</button>
            <button class="btn btn-hazard" onclick="toggleStorm()">‚òÄÔ∏è Solar Flare</button>
        </div>

        <div style="margin-top: 15px; border-top: 1px solid #333; padding-top:10px;">
            <div class="metric"><span>Route Latency:</span><span class="val ok" id="latVal">--</span></div>
            <div class="metric"><span>Signal Quality:</span><span class="val" id="sigVal">--</span></div>
            <div style="font-size:0.8em; color:#888; margin-top:5px;" id="routeDesc"></div>
        </div>
    </div>

    <script src="https://cesium.com/downloads/cesiumjs/releases/1.104/Build/Cesium/Cesium.js"></script>
    <script>
        const API = 'https://hyperspace-leo-network.onrender.com'; // Render backend
        let viewer, sats = new Map(), links = new Map(), routeLine, stormEntity, planeEntity;
        let srcCoords = {}, dstCoords = {};
        let solarActive = false;

        async function init() {
            try {
                const provider = await Cesium.ArcGisMapServerImageryProvider.fromUrl('https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer');
                viewer = new Cesium.Viewer('cesiumContainer', {
                    baseLayer: new Cesium.ImageryLayer(provider),
                    animation: false, timeline: false, baseLayerPicker: false,
                    fullscreenButton: false, geocoder: false, homeButton: false,
                    infoBox: false, sceneModePicker: false, selectionIndicator: false,
                    navigationHelpButton: false, requestRenderMode: true
                });
            } catch (e) {
                viewer = new Cesium.Viewer('cesiumContainer', { imageryProvider: false, baseLayer: false });
                viewer.scene.globe.baseColor = Cesium.Color.fromCssColorString('#001133');
            }
            viewer.scene.globe.enableLighting = true;
            setupAutocomplete('srcInput', 'srcList', (l, lo) => srcCoords = { lat: l, lon: lo });
            setupAutocomplete('dstInput', 'dstList', (l, lo) => dstCoords = { lat: l, lon: lo });
            setInterval(updateSats, 2000);
            updateSats();
        }

        // --- STORYTELLER FUNCTION ---
        function showStory(title, text, color) {
            const box = document.getElementById('storyBox');
            const titleEl = document.getElementById('storyTitle');
            const textEl = document.getElementById('storyText');

            box.style.display = 'block';
            box.style.borderColor = color;
            titleEl.innerText = title;
            titleEl.style.color = color;
            textEl.innerText = text;

            // Auto-hide after 8 seconds
            setTimeout(() => { box.style.display = 'none'; }, 8000);
        }

        async function updateSats() {
            try {
                const res = await fetch(`${API}/satellites`);
                const data = await res.json();
                document.getElementById('satCount').innerText = data.meta.count;

                viewer.entities.suspendEvents();

                // Draw Sats
                const currentIds = new Set(data.satellites.map(s => s.id));
                data.satellites.forEach(s => {
                    const pos = Cesium.Cartesian3.fromDegrees(s.lon, s.lat, s.alt * 1000);

                    // VISUAL: If Solar Storm is active, some sats turn BLACK (Dead)
                    // We use the load > 99 trick to identify "dead" sats or randomize visualization
                    let color;
                    if (solarActive && Math.random() > 0.8) {
                        color = Cesium.Color.fromCssColorString('#333333'); // Dead Grey
                    } else {
                        color = s.load > 80 ? Cesium.Color.RED : s.load > 50 ? Cesium.Color.YELLOW : Cesium.Color.LIME;
                    }

                    if (sats.has(s.id)) {
                        sats.get(s.id).position = pos;
                        sats.get(s.id).point.color = color;
                    } else {
                        sats.set(s.id, viewer.entities.add({ id: s.id, position: pos, point: { pixelSize: 6, color: color } }));
                    }
                });

                // Links
                links.forEach(l => viewer.entities.remove(l));
                links.clear();
                const posMap = new Map();
                data.satellites.forEach(s => posMap.set(s.id, Cesium.Cartesian3.fromDegrees(s.lon, s.lat, s.alt * 1000)));
                data.links.slice(0, 150).forEach(([id1, id2]) => {
                    const p1 = posMap.get(id1), p2 = posMap.get(id2);
                    if (p1 && p2) links.set(`${id1}-${id2}`, viewer.entities.add({ polyline: { positions: [p1, p2], width: 1, material: Cesium.Color.WHITE.withAlpha(0.1) } }));
                });

                viewer.entities.resumeEvents();
                viewer.scene.requestRender();
            } catch (e) { }
        }

        async function toggleRain() {
            const res = await fetch(`${API}/toggle-weather`, { method: 'POST' });
            const data = await res.json();

            if (data.status === "STORMY") {
                document.getElementById('envState').innerText = "HEAVY RAIN";
                document.getElementById('envState').className = "val err";

                // 1. Show Visual
                stormEntity = viewer.entities.add({
                    position: Cesium.Cartesian3.fromDegrees(-40.0, 35.0),
                    ellipse: { semiMinorAxis: 1500000.0, semiMajorAxis: 1500000.0, material: Cesium.Color.BLUE.withAlpha(0.4) }
                });

                // 2. Tell the Story
                showStory(
                    "üåßÔ∏è RAIN FADE DETECTED",
                    "Water absorbs high-frequency radio waves. The signal cannot pass through the storm directly. The system is rerouting data around the Atlantic to avoid packet loss.",
                    "#00d4ff"
                );
            } else {
                document.getElementById('envState').innerText = "NORMAL";
                document.getElementById('envState').className = "val";
                if (stormEntity) viewer.entities.remove(stormEntity);
            }
        }

        async function toggleStorm() {
            const res = await fetch(`${API}/toggle-storm`, { method: 'POST' });
            const data = await res.json();
            solarActive = data.storm_active;

            const container = document.getElementById('cesiumContainer');

            if (solarActive) {
                // 1. Visual: Red pulsing screen
                container.classList.add('solar-alert');
                document.getElementById('envState').innerText = "SOLAR FLARE";
                document.getElementById('envState').className = "val err";

                // 2. Story
                showStory(
                    "‚òÄÔ∏è SOLAR FLARE HIT",
                    "A Coronal Mass Ejection (CME) has hit Earth. High-energy particles are overloading satellite circuits. 20% of the fleet has entered 'Safe Mode' (OFFLINE) to prevent permanent damage.",
                    "#ff3333"
                );
            } else {
                container.classList.remove('solar-alert');
                document.getElementById('envState').innerText = "NORMAL";
                document.getElementById('envState').className = "val";
                showStory("‚úÖ SYSTEM RECOVERED", "Solar radiation levels have normalized. Satellites are rebooting.", "#00ff88");
            }
        }

        // --- STANDARD FUNCTIONS (Route/Flight/Autocomplete) ---
        function setupAutocomplete(inputId, listId, cb) {
            const input = document.getElementById(inputId);
            const list = document.getElementById(listId);
            let timeout;
            input.addEventListener('input', () => {
                clearTimeout(timeout);
                if (input.value.length < 3) { list.style.display = 'none'; return; }
                timeout = setTimeout(async () => {
                    try {
                        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${input.value}&limit=3`);
                        const data = await res.json();
                        list.innerHTML = '';
                        if (data.length) {
                            list.style.display = 'block';
                            data.forEach(p => {
                                const d = document.createElement('div');
                                d.className = 'suggestion-item';
                                d.innerText = p.display_name.split(',').slice(0, 2).join(',');
                                d.onclick = () => { input.value = p.display_name.split(',')[0]; list.style.display = 'none'; cb(p.lat, p.lon); };
                                list.appendChild(d);
                            });
                        }
                    } catch (e) { }
                }, 300);
            });
            document.addEventListener('click', e => { if (e.target !== input) list.style.display = 'none'; });
        }

        async function calcRoute(sLatOverride, sLonOverride) {
            let sLat = sLatOverride || srcCoords.lat || document.getElementById('srcInput').value;
            let sLon = sLonOverride || srcCoords.lon;
            let tLat = dstCoords.lat || document.getElementById('dstInput').value;
            let tLon = dstCoords.lon;
            if (!sLat) return;

            try {
                const res = await fetch(`${API}/route`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ source: { lat: sLat, lon: sLon }, target: { lat: tLat, lon: tLon } })
                });
                const data = await res.json();
                if (data.status === 'success') {
                    document.getElementById('latVal').innerText = data.latency_ms + " ms";
                    document.getElementById('latVal').className = data.weather_alert || solarActive ? "val err" : "val ok";
                    document.getElementById('sigVal').innerText = data.weather_alert ? "RAIN INTERFERENCE" : "STRONG";
                    document.getElementById('routeDesc').innerText = `Resolved: ${data.resolution.source_used} ‚Üí ${data.resolution.target_used}`;

                    if (routeLine) viewer.entities.remove(routeLine);
                    const positions = [];
                    positions.push(Cesium.Cartesian3.fromDegrees(data.resolution.source_coords[1], data.resolution.source_coords[0]));
                    data.path.forEach(id => { if (sats.has(id)) positions.push(sats.get(id).position.getValue(viewer.clock.currentTime)); });
                    positions.push(Cesium.Cartesian3.fromDegrees(data.resolution.target_coords[1], data.resolution.target_coords[0]));
                    routeLine = viewer.entities.add({ polyline: { positions: positions, width: 4, material: new Cesium.PolylineGlowMaterialProperty({ glowPower: 0.2, color: Cesium.Color.ORANGE }) } });
                }
            } catch (e) { }
        }

        function startFlightSim() {
            const start = { lat: 35.6, lon: 139.6 }; const end = { lat: -33.8, lon: 151.2 };
            document.getElementById('dstInput').value = "Sydney, Australia";
            dstCoords = { lat: end.lat, lon: end.lon };
            if (planeEntity) viewer.entities.remove(planeEntity);
            planeEntity = viewer.entities.add({ position: Cesium.Cartesian3.fromDegrees(start.lon, start.lat, 10000), point: { pixelSize: 20, color: Cesium.Color.YELLOW }, label: { text: "‚úàÔ∏è HYPER-1", font: "12px monospace", pixelOffset: new Cesium.Cartesian2(0, -20) } });
            let progress = 0;
            const interval = setInterval(() => {
                progress++;
                const pct = progress / 200;
                const curLat = start.lat + (end.lat - start.lat) * pct;
                const curLon = start.lon + (end.lon - start.lon) * pct;
                planeEntity.position = Cesium.Cartesian3.fromDegrees(curLon, curLat, 10000);
                calcRoute(curLat, curLon);
                if (progress >= 200) clearInterval(interval);
            }, 100);
        }

        init();
    </script>
</body>

</html>